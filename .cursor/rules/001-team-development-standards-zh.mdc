---
description: ALWAYS reference Team Development Standards during development to ensure consistency and maintainability
globs: **/*
alwaysApply: true
---

# å›¢é˜Ÿå¼€å‘è§„èŒƒ

## ç›®å½•

1. [æ²»ç†ä¸ä»£ç æ•´æ´](#governance)
2. [é”™è¯¯å¤„ç†ä¸æ¥å£](#errors-interfaces)
3. [Go å‘½åä¸åºåˆ—åŒ–](#naming-serialization)
4. [é…ç½®æ–‡ä»¶è§„èŒƒï¼ˆconfxï¼‰](#configuration)
5. [GORM ä½¿ç”¨è§„èŒƒ](#gorm-usage)
6. [æ•°æ®åº“ä¸è¿ç§»å®è·µ](#db-migrations)
7. [Proto ä¸ API æŒ‡å—](#proto-api)
8. [è¿è¡Œæ—¶ä¸éƒ¨ç½²](#runtime-deployment)
9. [åº“ä½¿ç”¨åå¥½](#library-preferences)
10. [è®¾è®¡æ¨¡å¼ä¸æ³¨æ„äº‹é¡¹](#design-cautions)

---

<a id="governance"></a>

## 1. æ²»ç†ä¸ä»£ç æ•´æ´

- ä¸¥å®¡ AIï¼ˆCursorï¼‰ç”Ÿæˆä»£ç ï¼šæäº¤å‰éœ€ä¸¥æ ¼äººå·¥å®¡æŸ¥ã€‚
- ç§»é™¤æœªä½¿ç”¨ä»£ç ï¼šä¿æŒä»£ç åº“ç²¾ç®€ã€å¯ç»´æŠ¤ã€‚
- è‹±æ–‡åŒ–ä»£ç ä¸æ³¨é‡Šï¼›æ–‡æ¡£éœ€æœ‰è‹±æ–‡ç‰ˆæœ¬ã€‚
- æ‹’ç»è¿‡åº¦æ³¨é‡Šï¼šä¼˜å…ˆé€šè¿‡æ¸…æ™°å‘½åä¸ç»“æ„æå‡å¯è¯»æ€§ï¼›ä»…åœ¨å¿…è¦æ—¶æ·»åŠ ç®€æ˜æ³¨é‡Šã€‚

> ğŸ’¡ æç¤ºï¼šå½“ä½ å‡†å¤‡å†™æ³¨é‡Šæ—¶ï¼Œå…ˆå°è¯•æ”¹è¿›å‘½åä¸æŠ½è±¡ï¼Œè®©ä»£ç è‡ªèº«è¡¨è¾¾è¯­ä¹‰ã€‚

---

<a id="errors-interfaces"></a>

## 2. é”™è¯¯å¤„ç†ä¸æ¥å£

- é”™è¯¯åŒ…è£…ç­–ç•¥ï¼š
  - å¤–éƒ¨å‡½æ•°è¿”å›çš„é”™è¯¯å¿…é¡»ä½¿ç”¨ `github.com/pkg/errors`ï¼ˆå¦‚ `errors.Wrap`ã€`errors.WithStack`ï¼‰ã€‚
  - æ–°å»ºé”™è¯¯ä½¿ç”¨ `errors.New`/`errors.Errorf`ï¼Œä¿ç•™é”™è¯¯èµ·æºè°ƒç”¨æ ˆã€‚
  - è‹¥èƒ½å¤Ÿä¿è¯é”™è¯¯å·²ç»è®°å½•äº†èµ·æºè°ƒç”¨æ ˆçš„å‰æä¸‹å¯ç›´æ¥é€ä¼ ï¼Œä¾‹å¦‚é€šå¸¸å†…éƒ¨å‡½æ•°å°±ä¸éœ€è¦å†æ¬¡ `Wrap` ã€‚
- é”™è¯¯æ¯”è¾ƒç»Ÿä¸€ä½¿ç”¨ `errors.Is`ï¼Œç¦æ­¢ `==` æ¯”è¾ƒã€‚
- gRPC è¾¹ç•Œï¼ˆæ–¹æ³•å®ç°æˆ–ä¸­é—´ä»¶ï¼‰å¼ºåˆ¶ä½¿ç”¨ `statusx`ï¼Œè¿™æ ·æ‰èƒ½å¾—åˆ° é”™è¯¯æ¶ˆæ•ã€é”™è¯¯ç¿»è¯‘ã€æ ‡å‡†åŒ–é”™è¯¯ç­‰ç­‰æœºåˆ¶ã€‚
  - æ³¨æ„ `statusx.Wrap` è‹¥é‡åˆ°å·²æ˜¯ status é”™è¯¯ï¼Œä¼šä»¥åº•å±‚ status ä¸ºå‡†çš„ï¼Œå¤šå±‚åŒ…è£¹ä¼šè¢«å¿½ç•¥ã€‚
- é¿å…ä½¿ç”¨ `panic`/`log.Fatal`ï¼Œä¼˜å…ˆè¿”å› `error`ã€‚
- æ‰€æœ‰ goroutine å¿…é¡»å…·å¤‡ `recover` é€»è¾‘ï¼Œé¿å…è¿›ç¨‹çº§å´©æºƒã€‚
- IO æ–¹æ³•ç­¾åï¼šå¿…é¡»ä»¥ `ctx context.Context` ä½œä¸ºé¦–å‚ï¼Œå¹¶è¿”å› `error`ã€‚
- interface å®ç°æ ¡éªŒï¼šæä¾›ç¼–è¯‘æœŸæ–­è¨€ï¼Œé˜²æ­¢åç»­å˜æ›´å¯¼è‡´æ½œåœ¨ä¸åŒ¹é…ã€‚

```go
// Compile-time interface assertion example
var _ MyInterface = (*MyImpl)(nil)
```

- å½“è¿”å›ç±»å‹å¯ä¸º interface å¹¶ä¸”å¯èƒ½ä¸º `nil` æ—¶ï¼Œç›´æ¥è¿”å›è¯¥ interface ç±»å‹è€Œéå…·ä½“ç±»å‹ï¼Œé¿å…â€œtyped-nilâ€é™·é˜±ã€‚

```go
// typed-nil pitfall: e has a concrete type, therefore e != nil
var e error = func() *errFoo { return nil }()
// e != nil is true
```

---

<a id="naming-serialization"></a>

## 3. Go å‘½åä¸åºåˆ—åŒ–

- å¸¸é‡ï¼š
  - ä¸šåŠ¡å­—ç¬¦ä¸²å¸¸é‡å€¼ä½¿ç”¨ SCREAMING_SNAKE_CASEï¼Œä¾‹å¦‚ï¼š`const StatusActive = "STATUS_ACTIVE"`ã€‚
  - è‹¥ä½œä¸ºé…ç½®é¡¹çš„é€‰é¡¹å€¼ï¼Œä½¿ç”¨ kebab-caseï¼Œä¾‹å¦‚ï¼š`const ModeReadOnly = "read-only"`ã€‚
- ç¼©å†™ï¼ˆAcronymsï¼‰åœ¨æ ‡è¯†ç¬¦ä¸­åº”å…¨å¤§å†™ï¼ˆå¦‚ `userID`ã€`HTTPServer`ï¼‰ï¼Œé™¤éä½äºæ ‡è¯†ç¬¦èµ·å§‹å¤„ï¼ˆå¦‚ `idGenerator`ï¼‰ã€‚ç¬¬ä¸‰æ–¹ç”Ÿæˆä»£ç å¯ä¾‹å¤–ã€‚
- åºåˆ—åŒ–ä¸é…ç½®å­—æ®µå‘½åï¼š
  - `json` tag ä¸ `confx` YAML å­—æ®µç»Ÿä¸€ä½¿ç”¨ `camelCase`ã€‚
  - ä¿æŒç¼©å†™å¤§å†™ï¼ˆå¦‚ `json:"userID"`, `json:"readTimeoutMS"`ï¼‰ï¼Œé¿å…æ··ç”¨ï¼ˆå¦‚ `userId`ï¼‰ã€‚
  - ç¬¬ä¸‰æ–¹ç”Ÿæˆä»£ç æˆ–å¤–éƒ¨ç³»ç»Ÿå¯¹æ¥çš„å‘½åå¯ä¾‹å¤–ã€‚
  - éå¿…è¦ä¸ä½¿ç”¨ `omitempty`ï¼Œé¿å…éšè—é€»è¾‘é”™è¯¯ã€‚
- åŒ…åä¸ import alias å¿…é¡»å…¨å°å†™ï¼›å¤šè¯å»ºè®® snake_caseï¼ˆå¦‚ `user_service`ï¼‰ï¼Œé™¤éæœ¬å°±å¾ˆæ¸…æ™°ï¼Œä¾‹å¦‚ï¼š`ledgerv1`ã€‚

- ç±»å‹åˆ«åï¼šä¼˜å…ˆä½¿ç”¨ `any` è€Œé `interface{}`ï¼ˆGo 1.18+ï¼‰ï¼Œæå‡å¯è¯»æ€§ï¼›

<a id="configuration"></a>

## 4. é…ç½®æ–‡ä»¶è§„èŒƒï¼ˆconfxï¼‰

- é»˜è®¤ embed çš„ YAML å¿…é¡»åˆ—å‡ºå¯¹åº” cmd çš„å…¨éƒ¨å¯é…ç½®é¡¹ï¼Œå³ä½¿ä¸ºé›¶å€¼ï¼›
- ä»¥å¯è¯»æ€§ä¼˜å…ˆï¼Œæ‰€æœ‰å­—æ®µæ˜¾å¼å£°æ˜ï¼Œä¾¿äºå®¡æŸ¥ã€å¯¹æ¯”ä¸æ–‡æ¡£åŒ–ï¼›
- éé»˜è®¤ YAML å¯æŒ‰éœ€è£å‰ªï¼ˆä¸å¼ºåˆ¶ï¼‰ã€‚
- ç¤ºä¾‹ï¼ˆcamelCaseï¼Œå¯¹é½ç¼©å†™å¤§å†™çº¦å®šï¼‰ï¼š

```yaml
# Default config (embedded)
server:
  port: 8080
  readTimeoutMS: 5000
  writeTimeoutMS: 5000
database:
  host: localhost
  port: 5432
  username: ""
  password: ""
features:
  enableAudit: true
  maxRetries: 0
```

---

<a id="gorm-usage"></a>

## 5. GORM ä½¿ç”¨è§„èŒƒ

- ç¦ç”¨å…³è”å†™å…¥ï¼šä¸å¾—ä½¿ç”¨ `db.Association(...)`ï¼ˆåŠ `Replace`ã€`Append` ç­‰ï¼‰ã€‚å¿…é¡»å¯ç”¨ `gormx.OmitAssociationsPlugin` é¿å…é»‘ç›’ä¿®æ”¹ã€‚
- æ‰€æœ‰ `gorm.DB` è°ƒç”¨å¿…é¡»ä¿è¯å…ˆå‰æœ‰è°ƒç”¨ `.WithContext(ctx)`ã€‚
- `Model()` ä¼ ç±»å‹éå®ä¾‹ï¼šä¾‹å¦‚ä½¿ç”¨ `db.Model(&User{})`ï¼Œé¿å…å®ä¾‹å­—æ®µè¢«éšå¼æ‹¼æ¥æˆæŸ¥è¯¢æ¡ä»¶ã€‚
- å­—ç¬¦ä¸²ä¸»é”®æŸ¥è¯¢ï¼ˆå¦‚ UUIDï¼‰ï¼šä¸å¾—å°†ä¸»é”®ç›´æ¥ä¼ ç»™ `First()`ï¼Œå¿…é¡»æ˜¾å¼ `WHERE` æ¡ä»¶ã€‚

```go
// Good
db.Where("id = ?", uuid).First(&model)

// Avoid
// db.First(&model, uuid) // may generate invalid SQL
```

- éå¿…è¦é¿å…ä½¿ç”¨ `UpdateColumn`ï¼Œå› ä¸ºå®ƒä¸ä¼šè§¦å‘ Hookã€‚

---

<a id="db-migrations"></a>

## 6. æ•°æ®åº“ä¸è¿ç§»å®è·µ

- ç ´åæ€§æ“ä½œå‰å…ˆæ ¡éªŒï¼šåœ¨æ‰§è¡Œ `DELETE`/`TRUNCATE` å‰ï¼Œåº”å‡†å¤‡å¹¶è¿è¡Œå¯¹åº” `SELECT` ç¡®è®¤ç›®æ ‡è®°å½•ã€‚
- å¤§æ‰¹é‡ DML åˆ†æ‰¹æ‰§è¡Œï¼š`INSERT`/`UPDATE`/`DELETE` åº”å¸¦æ¡ä»¶å¹¶åˆ†æ‰¹è¿è¡Œã€‚
- æ¶æ„å˜æ›´æ²»ç†ï¼ˆMVP ä¹‹åï¼‰ï¼š
  - é™¤æ–°å¢åˆ—å¤–çš„æ‰€æœ‰è¡¨ç»“æ„ä¿®æ”¹ï¼Œå¿…é¡»ç»è‡³å°‘ä¸¤ä½å®¡æŸ¥äººç¡®è®¤ã€‚
  - ç”Ÿäº§ç¯å¢ƒä¸­åˆ é™¤æˆ–é‡å‘½ååˆ—é»˜è®¤ç¦æ­¢ï¼›ä»…åœ¨å¤šæ–¹å®¡æŸ¥å¹¶æœ‰æ˜ç¡®è¿ç§»æ–¹æ¡ˆæ—¶å¯æ‰§è¡Œã€‚
- ä¸»é”®ç­–ç•¥ï¼š
  - å¼ºåˆ¶ä½¿ç”¨å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¦‚ UUIDã€XIDã€Snowflakeï¼‰ï¼Œç¦æ­¢ä½¿ç”¨è‡ªå¢ IDï¼›
  - ç¦æ­¢è”åˆä¸»é”®ï¼ˆComposite Primary Keyï¼‰ï¼›ä½¿ç”¨å•å­—æ®µä¸»é”® + ä¸šåŠ¡å±‚å”¯ä¸€çº¦æŸæ›¿ä»£ï¼›
  - é‡‡ç”¨å•ä¸»é”®å¯é¿å…åœ¨æŸ¥è¯¢æ—¶å¿…é¡»å°†è”åˆå”¯ä¸€çº¦æŸçš„æ‰€æœ‰å­—æ®µå…¨éƒ¨å¸¦å…¥ WHERE æ¡ä»¶ï¼Œé™ä½æ˜“é”™ç‡ã€å‡å°‘é—æ¼å¹¶æå‡å¯ç»´æŠ¤æ€§ï¼›
  - åŒæ—¶æ›´é€‚åº”åˆ†åº“åˆ†è¡¨ã€è·¨ç³»ç»Ÿæ•°æ®åˆå¹¶ä»¥åŠæœªæ¥çš„åˆ†å¸ƒå¼ç³»ç»Ÿéœ€æ±‚ã€‚
- ç¦ç”¨ `lib/pq` ä½œä¸º PostgreSQL é©±åŠ¨ã€‚

> ğŸ’¡ å¦è§ç‹¬ç«‹è§„åˆ™ï¼š`1050-database-design`ï¼ˆå®¡è®¡å­—æ®µç½®é¡¶ã€snake_caseã€è½¯åˆ é™¤åŠè¿‡æ»¤å”¯ä¸€/ç´¢å¼•ã€ç¦ç”¨ç‰©ç†å¤–é”®ã€ç´¢å¼•è¿‡æ»¤è½¯åˆ é™¤ç­‰ï¼‰ã€‚

---

<a id="proto-api"></a>

## 7. Proto ä¸ API æŒ‡å—

- å¯¼å…¥åˆ«åï¼šé¿å…ä¸å¿…è¦çš„åˆ«åï¼›ä½¿ç”¨è¯­ä¹‰æ¸…æ™°çš„ç‰ˆæœ¬åŒ–åˆ«åã€‚

```go
// Good
import authv1 "github.com/theplant/ciam-next/gen/ciam/auth/v1"

// Avoid
// import authpb "github.com/theplant/ciam-next/gen/ciam/auth/v1"
```

- æ¨¡å‹å­—æ®µï¼šproto model å®šä¹‰ä¸åŒ…å« `deleted_at`ã€‚è½¯åˆ é™¤å±äºæ•°æ®åº“å®ç°ç»†èŠ‚ï¼Œä¸åº”æš´éœ²äº API å±‚ã€‚

---

<a id="runtime-deployment"></a>

## 8. è¿è¡Œæ—¶ä¸éƒ¨ç½²

- gRPC è´Ÿè½½å‡è¡¡ï¼šåœ¨éƒ¨ç½²ç¯å¢ƒä¸­ä½¿ç”¨ headless Service + round-robinï¼Œç¡®ä¿è¯·æ±‚çº§è´Ÿè½½å‡è¡¡ï¼Œå¹¶æ­£ç¡®é…ç½®å®¢æˆ·ç«¯ç­–ç•¥ã€‚

---

<a id="library-preferences"></a>

## 9. åº“ä½¿ç”¨åå¥½

- è‹¥æ‰©å±•åŒ…æä¾›ç­‰ä»·æ–¹æ³•ï¼Œä¼˜å…ˆä½¿ç”¨æ‰©å±•åŒ…ï¼ˆå¦‚ `lox.Must`ã€`filepathx.Join`ã€`clonex.Clone`ã€`clonex.CloneSlowy`ã€`jsonx.Marshal`ï¼‰ï¼Œä»¥è·å¾—æ›´å¥½çš„é”™è¯¯å¤„ç†ã€æ€§èƒ½æˆ–åŠŸèƒ½å¢å¼ºã€‚
- æµ‹è¯•ä¼˜å…ˆä½¿ç”¨ github.com/stretchr/testify ã€‚

---

<a id="design-cautions"></a>

## 10. è®¾è®¡æ¨¡å¼ä¸æ³¨æ„äº‹é¡¹

- Interface Wrapperï¼šè‹¥ä¸‹æ¸¸ä¼šå¯¹åŸå§‹å¯¹è±¡åšé¢å¤–çš„æ¥å£æ–­è¨€ï¼Œwrapper å¯èƒ½æ”¹å˜è¯¥è¡Œä¸ºã€‚é™¤éç¡®è®¤æ— æ­¤éœ€æ±‚ï¼Œå¦åˆ™è€ƒè™‘åœ¨ wrapper ä¸­åµŒå…¥åŸå§‹ interfaceï¼Œä»¥ä¿ç•™æ–¹æ³•ä¸æ–­è¨€è¡Œä¸ºã€‚

---
